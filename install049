#!/bin/bash
set -e

GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
NC='\033[0m'

stage() { echo -e "\n${BLUE}========== $1 ==========${NC}"; }
progressbar() { local msg=$1; for i in {1..14}; do echo -ne "${CYAN}$msg$(printf '%*s' $((i%4)) | tr ' ' '.')\r${NC}"; sleep 0.10; done; echo ""; }
rocket_anim() { for i in $(seq 1 5); do echo -ne "ðŸš€"; sleep 0.1; done; echo ""; }

generate_password() { tr -dc 'A-Za-z0-9' < /dev/urandom | head -c 10; }
generate_login() { tr -dc 'A-Za-z' < /dev/urandom | head -c 6; }
validate_login() { [[ "$1" =~ ^[a-zA-Z0-9-]{3,}$ ]]; }
validate_password() { [[ ${#1} -ge 8 ]]; }

echo -e "${GREEN}\nâœ¨ Marzban 0.4.9 Ð‘Ñ‹ÑÑ‚Ñ€Ð°Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° âœ¨${NC}\n"
echo -e "${BLUE}âœ¨Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ñ‰Ð¸Ðº Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½ alexcoder ÑÐ¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ð¾ Ð´Ð»Ñ ÐºÑƒÑ€ÑÐ° Ð½Ð° skladchik.orgâœ¨${NC}\n"

if [[ $EUID -ne 0 ]]; then
  echo -e "${YELLOW}[!] Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÑ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¾Ñ‚ Ð¸Ð¼ÐµÐ½Ð¸ root! (sudo su)${NC}"
  exit 1
fi

while true; do
    read -rp "ðŸ‘¤ Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¸Ð¼Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð° (3+ Ð»Ð°Ñ‚Ð¸Ð½ÑÐºÐ¸Ñ… Ð±ÑƒÐºÐ²Ñ‹/Ñ†Ð¸Ñ„Ñ€Ñ‹, Ð¸Ð»Ð¸ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð½Ð°Ð¶Ð°Ñ‚ÑŒ Enter Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸): " ADMIN_USER
    if [[ -z "$ADMIN_USER" ]]; then
        ADMIN_USER=$(generate_login)
        echo -e "${CYAN}ðŸ†• Ð¡Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ð»Ð¾Ð³Ð¸Ð½: $ADMIN_USER${NC}"
        break
    fi
    if validate_login "$ADMIN_USER"; then
        break
    else
        echo -e "${YELLOW}âŒ Ð›Ð¾Ð³Ð¸Ð½ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð½Ðµ Ð¼ÐµÐ½ÐµÐµ 3 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð², Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð»Ð°Ñ‚Ð¸Ð½Ð¸Ñ†Ð°, Ñ†Ð¸Ñ„Ñ€Ñ‹.${NC}"
    fi
done

while true; do
    read -srp "ðŸ”‘ Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð° (Ð¼Ð¸Ð½. 8 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð², Ð¸Ð»Ð¸ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð½Ð°Ð¶Ð°Ñ‚ÑŒ Enter Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸): " ADMIN_PASS1; echo
    if [[ -z "$ADMIN_PASS1" ]]; then
        ADMIN_PASS=$(generate_password)
        echo -e "\n${CYAN}ðŸ”’ Ð¡Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ: $ADMIN_PASS${NC}"
        break
    fi
    read -srp "ðŸ”‘ ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚Ðµ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ: " ADMIN_PASS2; echo
    if [[ "$ADMIN_PASS1" != "$ADMIN_PASS2" ]]; then
        echo -e "${YELLOW}âŒ ÐŸÐ°Ñ€Ð¾Ð»Ð¸ Ð½Ðµ ÑÐ¾Ð²Ð¿Ð°Ð´Ð°ÑŽÑ‚! ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ñ‘ Ñ€Ð°Ð·.${NC}"
        continue
    fi
    if ! validate_password "$ADMIN_PASS1"; then
        echo -e "${YELLOW}âŒ ÐŸÐ°Ñ€Ð¾Ð»ÑŒ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð½Ðµ Ð¼ÐµÐ½ÐµÐµ 8 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð².${NC}"
        continue
    fi
    ADMIN_PASS="$ADMIN_PASS1"
    break
done

stage "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹"
progressbar "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²"
DEBIAN_FRONTEND=noninteractive apt-get update -y -qq && \
DEBIAN_FRONTEND=noninteractive apt-get upgrade -y -qq
progressbar "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Docker Ð¸ Git"
DEBIAN_FRONTEND=noninteractive apt-get install -y -qq ca-certificates curl gnupg lsb-release git nginx docker.io docker-compose-plugin jq
sleep 3

stage "Ð’ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Docker"
systemctl enable --now docker

stage "Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Marzban 0.4.9"
progressbar "ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹"
rm -rf /opt/marzban
git clone --branch v0.4.9 --depth 1 https://github.com/Gozargah/Marzban.git /opt/marzban > /dev/null

cd /opt/marzban

stage "Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ docker-compose.yml"
progressbar "Ð“Ð¾Ñ‚Ð¾Ð²Ð¸Ð¼ Docker Compose"
cat > docker-compose.yml <<EOF
services:
  marzban:
    image: gozargah/marzban:v0.4.9
    restart: always
    network_mode: host
    environment:
      - ADMIN_USERNAME=$ADMIN_USER
      - ADMIN_PASSWORD=$ADMIN_PASS
      - UVICORN_HOST=0.0.0.0
      - UVICORN_PORT=8000
    volumes:
      - /var/lib/marzban:/var/lib/marzban
      - /var/log/marzban:/var/log/marzban
EOF

stage "Ð—Ð°Ð¿ÑƒÑÐº Marzban"
progressbar "Ð—Ð°Ð¿ÑƒÑÐº ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°"
docker compose down > /dev/null 2>&1 || true
docker compose up -d > /dev/null

sleep 8
if ! docker compose ps | grep -q Up; then
    echo -e "${YELLOW}âŒ ÐšÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Marzban Ð½Ðµ ÑÑ‚Ð°Ñ€Ñ‚Ð¾Ð²Ð°Ð»! ÐŸÐ¾ÑÐ¼Ð¾Ñ‚Ñ€Ð¸Ñ‚Ðµ Ð»Ð¾Ð³Ð¸ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð¾Ð¹: docker compose logs"
    echo -e "${YELLOW}Ð•ÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð° Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒ â€” Ð¾Ð±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ Ðº Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÑƒ Ð¸Ð»Ð¸ Ð² Ñ‚ÐµÐ¼Ñƒ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸ ÐºÑƒÑ€ÑÐ°.${NC}"
    exit 1
fi

echo -e "${CYAN}Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð° Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸...${NC}"
echo -e "y\n\n\n" | docker compose exec -T marzban marzban-cli admin create --username "$ADMIN_USER" --password "$ADMIN_PASS" || true

stage "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°"
rocket_anim

IP=$(curl -s http://checkip.amazonaws.com)

INFO_FILE="/root/vpn-install-info.txt"
cat > "$INFO_FILE" <<EOF
Marzban v0.4.9 (Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð±ÐµÐ· Ð´Ð¾Ð¼ÐµÐ½Ð°/SSL)
=========================================
Ð”Ð°Ñ‚Ð°: $(date)
ÐŸÐ°Ð½ÐµÐ»ÑŒ: http://$IP:8000/dashboard

Ð›Ð¾Ð³Ð¸Ð½: $ADMIN_USER
ÐŸÐ°Ñ€Ð¾Ð»ÑŒ: $ADMIN_PASS
EOF

chmod 600 "$INFO_FILE"

echo -e "${GREEN}ðŸŽ‰ Marzban 0.4.9 ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ð¸ Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ðµ!${NC}\n"
echo -e "ðŸŒ ${CYAN}ÐŸÐ°Ð½ÐµÐ»ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð° Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ: http://$IP:8000/dashboard${NC}"
echo -e "ðŸ‘¤ ${CYAN}Ð›Ð¾Ð³Ð¸Ð½ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°:${NC} $ADMIN_USER"
echo -e "ðŸ”‘ ${CYAN}ÐŸÐ°Ñ€Ð¾Ð»ÑŒ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°:${NC} $ADMIN_PASS\n"

echo -e "${YELLOW}Ð’ÑÐµ Ð´Ð°Ð½Ð½Ñ‹Ðµ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ñ‹ Ð²: ${CYAN}$INFO_FILE${NC}"
echo -e "${GREEN}Ð­Ñ‚Ð¾Ñ‚ Ñ„Ð°Ð¹Ð» Ð·Ð°Ñ‰Ð¸Ñ‰Ñ‘Ð½ Ð¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ root (ÑÑƒÐ¿ÐµÑ€Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ).${NC}\n"

echo -e "${YELLOW}Ð•ÑÐ»Ð¸ Ð¿Ð¾Ñ€Ñ‚ 8000 Ð·Ð°ÐºÑ€Ñ‹Ñ‚ â€” Ð¾Ñ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ ÐµÐ³Ð¾ Ð² Ð¿Ð°Ð½ÐµÐ»Ð¸ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐµÑ€Ð²ÐµÑ€Ð°.${NC}"
echo -e "${YELLOW}Ð˜Ð»Ð¸ Ð¾Ñ‚ÐºÐ°Ñ‚Ð¸Ñ‚Ðµ ÑÐµÐ²Ñ€ÐµÑ€ Ð´Ð¾ Ð·Ð°Ð²Ð¾Ð´ÑÐºÐ¸Ñ… Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº Ð² Ð»Ð¸Ñ‡Ð½Ð¾Ð¼ ÐºÐ°Ð±Ð¸Ð½ÐµÑ‚Ðµ Ð²Ð°ÑˆÐµÐ³Ð¾ VDS${NC}"
echo -e "${BLUE}Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½ alexcoder Ð´Ð»Ñ ÐºÑƒÑ€ÑÐ° Ð½Ð° skladchik.org${NC}"
echo -e "${CYAN}ÐžÑ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ð°Ñ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ: https://github.com/Gozargah/Marzban/wiki${NC}\n"
echo -e "${CYAN}Ð’Ð°Ñˆ ÑÐµÑ€Ð²ÐµÑ€ Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ðµ! ðŸš€${NC}\n"
